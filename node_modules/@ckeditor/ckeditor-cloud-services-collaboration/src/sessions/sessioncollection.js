/*
 *             Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{Collection}from'ckeditor5/src/utils.js';import _0x4cfa71 from'./../users/user.js';import _0x15908f from'./../websocketgateway/websocketgateway.js';import _0x1c0a80 from'./responses/sessionsconnectresponse.js';import _0x2b912b from'./messages/sessionsconnectmessage.js';import _0x1898a0 from'./messages/socketconnectmessage.js';import _0x52651b from'./messages/socketdisconnectmessage.js';import _0x227665 from'./../messagescompressor.js';export const _SERVICE=0x3;export default class extends Collection{['_id'];['_sessionType'];['_handlers']=new Map();['_channel'];['_wsGateway'];['_connected'];['_eventsQueue']=[];['_isRunning']=!0x1;constructor(_0x1c5b33,_0x24c61b){super({'idProperty':'id'}),this['_id']=_0x1c5b33,this['_sessionType']=_0x24c61b;}async['connect'](_0x31ded8){this['_wsGateway']=_0x31ded8,this['stopListening'](_0x31ded8,'change:state');const _0xf72cb4=new _0x2b912b(this['_id'],this['_sessionType']);let _0xd4b8db;try{const _0x7129ce=await this['_wsGateway']['_sendRequest'](0x3,_0x2b912b['TYPE'],_0x227665['encode'](_0xf72cb4));_0xd4b8db=_0x227665['decode'](_0x7129ce,_0x1c0a80);}catch(_0x2a4aac){_0xd4b8db=new _0x1c0a80(this['_id'],[]);}this['_connectToChannel'](this['_wsGateway'],_0xd4b8db['channel'],this['_sessionType']);const _0x37ac53=await async function(_0x51a49a,_0x2660a5){const _0x13d9bb=_0x2660a5['map'](_0x5406ab=>_0x5406ab['userId']),_0x3c507f=_0x13d9bb['length']?await _0x4cfa71['getMany'](_0x51a49a,_0x13d9bb):[];return _0x2660a5['map'](_0x2a03d4=>{const _0x5ca781={'id':_0x2a03d4['id'],'role':_0x2a03d4['role'],'permissions':_0x2a03d4['permissions']};return _0x5ca781['user']=_0x2a03d4['userId']&&_0x3c507f['find'](_0x2a42dc=>_0x2a42dc['id']===_0x2a03d4['userId'])||new _0x4cfa71(),_0x5ca781;});}(this['_wsGateway'],_0xd4b8db['sockets']);for(const _0x287dc6 of _0x37ac53)super['add'](_0x287dc6);this['_connected']=!0x0,this['fire']('connected'),this['listenTo'](this['_wsGateway'],'change:state',(_0x192c1a,_0x267020,_0x545ce3)=>this['_onWsGatewayStateChange'](_0x545ce3),{'priority':_0x15908f['_CHANGE_STATE_EVENT_PRIORITY']}),await this['_runQueue']();}['disconnect'](_0x3f7c3e=!0x0){if(this['_connected']){for(this['_connected']=!0x1,this['_eventsQueue']=[];this['length'];)super['remove'](0x0);this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_wsGateway']&&_0x3f7c3e&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['fire']('disconnected'),_0x3f7c3e&&this['stopListening']();}}['add'](_0x49985d,_0x25e7c3){throw new TypeError('The\x20collection\x20is\x20read-only.');}['remove'](_0x502b4d){throw new TypeError('The\x20collection\x20is\x20read-only.');}['_connectToChannel'](_0x21a0f5,_0x1cdcc9,_0x1f1bb0){this['_channel']=_0x21a0f5['_getChannel'](_0x1f1bb0,_0x1cdcc9),this['_channel']&&(this['_addHandler'](this['_channel'],_0x1898a0['TYPE'],async _0x459ff8=>{const _0xe17c09=_0x227665['decode'](_0x459ff8,_0x1898a0);if(-0x1===this['getIndex'](_0xe17c09['id'])){const _0x577d28={'id':_0xe17c09['id'],'role':_0xe17c09['role'],'permissions':_0xe17c09['permissions']};_0xe17c09['userId']&&(_0x577d28['user']=await _0x4cfa71['get'](_0x21a0f5,_0xe17c09['userId'])),super['add'](_0x577d28);}}),this['_addHandler'](this['_channel'],_0x52651b['TYPE'],_0x4c7bf4=>{const _0x413034=_0x227665['decode'](_0x4c7bf4,_0x52651b);-0x1!==this['getIndex'](_0x413034['id'])&&super['remove'](_0x413034['id']);}));}async['_onWsGatewayStateChange'](_0x32ef9a){_0x32ef9a===_0x15908f['STATE_DISCONNECTED']&&this['disconnect'](!0x1),_0x32ef9a===_0x15908f['STATE_CONNECTED']&&await this['connect'](this['_wsGateway']);}async['_runQueue'](){if(this['_isRunning']||!this['_connected'])return;let _0x3bee53;for(this['_isRunning']=!0x0;_0x3bee53=this['_eventsQueue']['shift']();){const _0x4e96a5=this['_handlers']['get'](_0x3bee53['eventName']);_0x4e96a5&&await _0x4e96a5(_0x3bee53['data']);}this['_isRunning']=!0x1;}['_addHandler'](_0x219a60,_0x510330,_0x1bd391){const _0x43b939=_0x219a60['getEventName'](_0x510330,!0x0);this['listenTo'](_0x219a60,_0x43b939,async(_0x4374c2,_0x2201a7)=>{const _0x125f5e=_0x4374c2['name'];this['_eventsQueue']['push']({'eventName':_0x125f5e,'data':_0x2201a7}),await this['_runQueue']();}),this['_handlers']['set'](_0x43b939,_0x1bd391);}}