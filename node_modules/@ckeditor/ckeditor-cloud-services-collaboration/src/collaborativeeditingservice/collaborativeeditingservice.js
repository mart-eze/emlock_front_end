/*
 *             Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{v4 as _0x13dad2}from'uuid';import{EmitterMixin}from'ckeditor5/src/utils.js';import _0x49fde6 from'./../messagescompressor.js';import _0x4eafd7 from'./../sessions/sessions.js';import _0xa9af73 from'./messages/collaborativeeditingconnectmessage.js';import _0x4d13f5 from'./messages/collaborativeeditingupdatemessage.js';import _0x3810cd from'./messages/collaborativeeditingreconnectmessage.js';import _0x2acf53 from'./responses/collaborativeeditingresponse.js';import _0x1de0db from'./responses/collaborativeeditingconnectresponse.js';import _0x3c826f from'./../websocketgateway/websocketgateway.js';import _0x34ee1a from'../ckeditorcloudserviceserror.js';import _0x5e79df from'../errors/ServiceNotConnectedError.js';import _0x2048a7 from'./responses/getdocumentdetailsresponse.js';import _0x2a1122 from'./messages/getdocumentdetailsmessage.js';export const _SERVICE=0x1;export default class extends/* #__PURE__ -- @preserve */
EmitterMixin(){static ['_SERVICE']=0x1;['_bundleVersion'];['_id'];['_isConnected'];['_wsGateway'];['_channel'];['_connectedSessions'];constructor(_0x178132,_0x194eca){if(super(),!_0x178132)throw new TypeError('Param\x20\x22bundleVersion\x22\x20must\x20be\x20provided.');this['_id']=_0x194eca??_0x13dad2(),this['_isConnected']=!0x1,this['_bundleVersion']=_0x178132;}['getId'](){return this['_id'];}['isConnected'](){return this['_isConnected'];}['connect'](_0x1c6ff7,_0x2ea723={'buffers':[],'types':[]},_0x1e877a){const _0x41b412=new _0xa9af73(this['getId'](),_0x2ea723['buffers'],_0x2ea723['types'],this['_bundleVersion'],_0x1e877a);return this['_connect'](_0x1c6ff7,_0x41b412);}['reconnect'](_0x23dc1c,_0x586fe4){if(this['isConnected']())throw new _0x34ee1a('Cannot\x20reconnect\x20to\x20already\x20connected\x20service.',_0x23dc1c);return this['_connect'](_0x23dc1c,new _0x3810cd(this['getId'](),_0x586fe4,this['_bundleVersion']));}['disconnect'](){this['_isConnected']&&(this['_isConnected']=!0x1,this['_wsGateway']&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_connectedSessions']&&(this['_connectedSessions']['disconnect'](),this['_connectedSessions']=void 0x0),this['fire']('disconnected'),this['stopListening']());}async['getDocumentDetails'](){const _0x37efcd=new _0x2a1122(this['getId']());if(!this['_wsGateway'])throw new _0x5e79df('Collaborative\x20Editing',this);const _0x591a91=await this['_wsGateway']['_sendRequest'](0x1,_0x2a1122['TYPE'],_0x49fde6['encode'](_0x37efcd));return _0x49fde6['decode'](_0x591a91,_0x2048a7);}async['sendOperations'](_0x276bd0,_0x2b6737,_0x313e3a){if(!_0x276bd0?.['types']?.['length'])throw new _0x34ee1a('Cannot\x20send\x20empty\x20update.',this['_wsGateway']);const _0x90592='number'==typeof _0x2b6737?_0x2b6737:parseInt(_0x2b6737);if(!Number['isInteger'](_0x90592)||_0x90592<0x0)throw new _0x34ee1a('Base\x20version\x20not\x20provided.',this['_wsGateway']);const _0x47f1ae=new _0x4d13f5(this['getId'](),_0x276bd0['buffers'],_0x276bd0['types'],_0x90592,[],_0x313e3a);if(!this['_wsGateway']||!this['_isConnected'])throw new _0x5e79df('Collaborative\x20Editing',this);const _0x126dd6=await this['_wsGateway']['_sendRequest'](0x1,_0x4d13f5['TYPE'],_0x49fde6['encode'](_0x47f1ae));return _0x49fde6['decode'](_0x126dd6,_0x2acf53);}async['getConnectedSessions'](){if(!this['_isConnected'])throw new _0x5e79df('Collaborative\x20Editing',this);return this['_connectedSessions']||(this['_connectedSessions']=await _0x4eafd7['getConnectedSessions'](this['_wsGateway'],this['_id'],0x1)),this['_connectedSessions'];}static['getConnectedSessions'](_0x542c56,_0x2f4a8a){return _0x4eafd7['getConnectedSessions'](_0x542c56,_0x2f4a8a,0x1);}async['_connect'](_0x1b56af,_0x2659f5){if(this['isConnected']())return;if(_0x1b56af['state']!==_0x3c826f['STATE_CONNECTED'])throw new _0x34ee1a('WebSocket\x20Gateway\x20is\x20not\x20connected.',_0x1b56af);this['_wsGateway']=_0x1b56af,this['stopListening'](_0x1b56af,'change:state');const _0x32a30c=await _0x1b56af['_sendRequest'](0x1,_0x2659f5['constructor']['TYPE'],_0x49fde6['encode'](_0x2659f5)),_0x2d1d4c=_0x49fde6['decode'](_0x32a30c,_0x1de0db);return this['listenTo'](_0x1b56af,'change:state',(_0xa36e1f,_0x146b49,_0x16cc75)=>this['_onWsGatewayStateChange'](_0x16cc75),{'priority':_0x3c826f['_CHANGE_STATE_EVENT_PRIORITY']}),this['_connectToChannel'](_0x1b56af,_0x2d1d4c['channel']),this['_isConnected']=!0x0,this['fire']('connected'),_0x2d1d4c;}['_connectToChannel'](_0x19e9a6,_0x9db4e5){this['_channel']=_0x19e9a6['_getChannel'](0x1,_0x9db4e5),this['listenTo'](this['_channel'],this['_channel']['getEventName'](_0x4d13f5['TYPE']),(_0x3f0674,_0x10a2f0)=>{const _0x4b94e2=_0x49fde6['decode'](_0x10a2f0,_0x4d13f5);this['fire']('operationsReceived',_0x4b94e2['baseVersion'],_0x4b94e2['data'],_0x4b94e2['metadata']);});}['_onWsGatewayStateChange'](_0x3d62c4){_0x3d62c4===_0x3c826f['STATE_DISCONNECTED']&&this['disconnect']();}}